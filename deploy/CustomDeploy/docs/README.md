# How to deploy a self-host CCME web application

## Prerequisites
1. Co-Admin/Contributor access to any Azure subscription
2. PowerShell with [AzureRM](https://www.powershellgallery.com/packages/AzureRM) and [AzureAD](https://www.powershellgallery.com/packages/AzureAD) modules installed
3. [For manual deployment in Azure China] [Azure CLI 2.0](https://docs.microsoft.com/en-us/cli/azure/?view=azure-cli-latest) installed on local machine

## Standard deployment
Standard deployment includes all Azure resources necessary for CCME web application. Customer could use this deployment to perform migration assessment.

### Automatic deployment steps
#### Step 1: Start PowerShell
Start local PowerShell or open the Cloud Shell for PowerShell on Azure Portal.

#### Step 2: Login to Azure and Graph API
Run command `Login-AzureRmAccount` and `Connect-AzureAD` to login. Then select the target subscription by `Select-AzureRMSubscription`.

Sample command lines for Azure China:
```powershell
Login-AzureRmAccount -Environment AzureChinaCloud
Connect-AzureAD -AzureEnvironmentName AzureChinaCloud
Select-AzureRMSubscription -SubscriptionName "{your subscription name}"
```

#### Step 3: Perform deployment via PowerShell script
Run `scripts\CustomDeploy.ps1` with parameters below:

```
-displayName {display name} -location {target location}.
```

Note:
* The AAD application display name, web site URL and resource group name could be generated by the parameter `{display name}`. You can also explicitly specify them by optional parameters `{aadApplicationDisplayName}`, `{websiteName}` and `{resourceGroupName}`
* The AAD application secret and SQL server admin password will be automatically generated and output once deployment completed. Please store them in secure place.

### Manual deployment steps
#### Step 1: Create AAD Application
Run command line below in the Cloud Shell on Azure Portal or local Azure CLI:

```bash
az ad app create
    --available-to-other-tenants true
    --native-app false
    --display-name {App display name}
    --identifier-uris {identifier URI}
    --key-type Password
    --password {password}
    --required-resource-access "[{'resourceAppId': '797f4846-ba00-4fd7-ba43-dac1f8f63013', 'resourceAccess': [{'id':'41094075-9dad-400e-a0bd-54e686782033','type': 'Scope'}]}]"
```

Sample output:

```json
{
    "acceptMappedClaims": null,
    "addIns": [],
    "appId": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "appPermissions": null,
    ...
}
```

Note:
* Check [az ad app create](https://docs.microsoft.com/en-us/cli/azure/ad/app?view=azure-cli-latest#az-ad-app-create) for detail of parameters.
* Parameter `{identifier URI}` should be verified domain of the company or its sub-domain. The default domain could be found in the `Azure Active Directory` blade on Azure portal. Usually, it will in form like `*.onmicrosoft.com` (Global Azure) or `*.partner.onmschina.cn` (Azure China).
* Please record value of `appId` in the output and parameter `password` for later use.

#### Step 2: Create Deployment via ARM template

Click the following link: [Deploy To Azure](https://portal.azure.com/#create/Microsoft.Template/uri/https%3a%2f%2fraw.githubusercontent.com%2fAzure%2fccme%2fprerelease%2fdeploy%2fCustomDeploy%2farm_templates%2fazuredeploy.json%3ftoken%3dALW9HAJGHjVGlKGP1mANCBJeSuzM7Wocks5bUFviwA%253D%253D)

Note:
* Input the recorded `appId` from previous step to `AAD Application Id` and recorded `password` from previous step to `AAD Application Secret`.
* Record the value of `webAppLink` in the output of deployment for later use.

### Step 3: Update reply URL of the AAD application
Run command line below in Cloud Shell of Azure Portal or local Azure CLI:
```bash
az ad app update
    --id {App ID}
    --reply-urls {Reply URL}
```

Note:
1. Parameter `{App ID}` should be the `appId` recorded in step #1.
2. Parameter `{Reply URL}` should be the `webAppLink` recorded in step #2.

## Local deployment
Local deployment includes Azure Storage and Azure SQL for CCME web application, but no the application itself. Customer could run the web application on their local machine for development or debugging.

### Automatic deployment steps
#### Step 1: Start PowerShell
Start local PowerShell or open the Cloud Shell for PowerShell on Azure Portal.

#### Step 2: Login to Azure and Graph API
Run command `Login-AzureRmAccount` and `Connect-AzureAD` to login. Then select the target subscription by `Select-AzureRMSubscription`.

#### Step 3: Perform deployment via PowerShell script
Run `scripts\CustomLocalDeploy.ps1` with parameters below:

```
-displayName {display name} -location {target location}.
```

#### Step 4: Apply config to solution
Copy the output file `{displayName}.local.config` into the solution root folder and rename it as `local.config`. Now the solution is ready for local debugging.

Note:
1. The database created for local deployment is open for all IPs by default. Please refine the firewall rule manually for secure
2. The port number of `ReplyUri` of the AAD application may be variant depended on the environment. Please run the application to check the actual port number


### Manual deployment steps
#### Step 1: Create AAD Application
(Exactly same as Step 1 for standard deployment)

#### Step 2: Create Deployment via ARM template

Click the following link: [Deploy To Azure](https://portal.azure.com/#create/Microsoft.Template/uri/https%3a%2f%2fraw.githubusercontent.com%2fAzure%2fccme%2fprerelease%2fdeploy%2fCustomDeploy%2farm_templates%2flocaldeploy.json%3ftoken%3dALW9HAlj-4_XcnXwsbx92qW2uJrBVs4hks5bYAr1wA%253D%253D)

Note:
* Input the recorded `appId` from previous step to `AAD Application Id` and recorded `password` from previous step to `AAD Application Secret`.
* Record the value of `sqlDatabaseConnectionString` and `StorageAccountConnectionString` in the output of deployment for later use.

#### Step 3: Update configuration of the web application

Open file `web.config` in project `AssessmentWebApp`. Locate and replace settings below:
* `CCMEDB` in section `connectionStrings`: replace with the `sqlDatabaseConnectionString` recorded in step #2.
* `ApplicationId` in section `appSettings`: replace with the `appId` recorded in step #1.
* `ApplicationSecret` in section `appSettings`: replace with the `password` recorded in step #1.
* `StorageAccountConnectionString` in section `appSettings`: replace with the `StorageAccountConnectionString` recorded in step #2.

Note:
* The port number of `ReplyUri` in section `appSettings` may be variant depended on the environment. Please run the application to check the actual port number

#### Step 4: Update reply URL of the AAD application

Run the command line exactly same as the Step 3 for standard deployment (use `RedirectUri` in section `appSettings` for parameter `{Reply URL}`)